# Bug Fixes - 2026-01-31

## Summary

Fixed all reported issues:
1. Sales dashboard API 500 error
2. Missing /team page (404 error)
3. Navigation home button redirect issues
4. Improved error handling across APIs

All fixes include regression tests to prevent future issues.

---

## Issue 1: Sales Dashboard API 500 Error

**Location:** `app/api/sales/dashboard/route.ts`

**Problem:**
The API was returning a 500 error when the leaderboard table was empty or the query failed. The code treated the leaderboard as critical when it should be optional.

**Fix:**
- Changed leaderboard error handling to be non-critical
- Continue with empty array if leaderboard query fails
- Only leads query failure returns 500 error
- Added warning log for leaderboard failures

**Code Changes:**
```typescript
// Before: Treated leaderboard as critical
if (leadsError || leaderboardError) {
  return NextResponse.json({ error: "Unable to load sales dashboard" }, { status: 500 });
}

// After: Leaderboard is optional
if (leadsError) {
  return NextResponse.json({ error: "Unable to load sales dashboard" }, { status: 500 });
}
if (leaderboardError) {
  console.warn("Leaderboard query failed (non-critical):", leaderboardError);
}
```

**Testing:**
- Sales dashboard now works even with empty leaderboard table
- API gracefully handles leaderboard query failures
- Tests added in `tests/bugFixes.test.ts`

---

## Issue 2: Missing /team Page (404 Error)

**Location:** `app/(app)/team/page.tsx`

**Problem:**
Only `/team/[id]` page existed. The `/team` route returned 404 even though BottomNavMobile.tsx had a link to it for admin/manager roles.

**Fix:**
Created new team list page at `app/(app)/team/page.tsx` with:
- Role-based access control (admin and manager only)
- Lists all team members from user_profiles table
- Links to individual team member detail pages
- Proper error handling for all error states
- French labels and UI text
- Mobile-first responsive design

**Features:**
- Shows team member name, role, phone, and status
- Click to view detail page at `/team/[id]`
- "Add member" button links to admin users page
- Proper session expiry and permission handling
- Role labels in French (Administrateur, Gestionnaire, etc.)
- Status badges (Actif, Inactif, Suspendu)

**Testing:**
- Tests added in `tests/teamPage.test.tsx`
- Verified route exists and is accessible
- Documented role permissions

---

## Issue 3: Navigation Home Button Redirect Issues

**Location:** Multiple files

**Problem:**
Clicking "Home" always redirected to `/dashboard` regardless of user role. This caused:
- Sales reps going to wrong dashboard (should be `/sales/dashboard`)
- Technicians going to wrong page (should be `/technician`)
- Poor user experience

**Root Cause:**
`sanitizeRedirect()` function had hardcoded `/dashboard` fallback without role awareness.

**Fix:**
Implemented role-aware redirect system across the application:

1. **Added `getDefaultDashboard()` in `lib/types.ts`:**
   - Returns role-appropriate dashboard
   - sales_rep → `/sales/dashboard`
   - technician → `/technician`
   - admin/manager → `/dashboard`

2. **Updated `sanitizeRedirect()` in `lib/types.ts`:**
   - Added optional `role` parameter
   - Uses role-based default when no explicit fallback provided
   - Maintains backward compatibility

3. **Updated login API (`app/api/auth/login/route.ts`):**
   - Returns user role in response
   - Client can use role for redirect logic

4. **Updated 2FA verification API (`app/api/auth/verify-2fa/route.ts`):**
   - Returns user role in response
   - Enables role-aware redirect after 2FA

5. **Updated LoginForm (`components/auth/LoginForm.tsx`):**
   - Uses role from API response
   - Calculates role-aware redirect
   - Auto-login checks role before redirecting

6. **Updated VerifyTwoFactorForm (`components/auth/VerifyTwoFactorForm.tsx`):**
   - Uses role from API response
   - Redirects to role-appropriate dashboard

**Code Changes:**

```typescript
// New function in lib/types.ts
export function getDefaultDashboard(role?: string): string {
  switch (role) {
    case "sales_rep":
      return "/sales/dashboard";
    case "technician":
      return "/technician";
    case "admin":
    case "manager":
    default:
      return "/dashboard";
  }
}

// Updated sanitizeRedirect signature
export function sanitizeRedirect(
  target: string | null | undefined,
  fallback?: string,
  role?: string
): string {
  const defaultFallback = fallback || getDefaultDashboard(role);
  // ... rest of logic
}
```

**Backward Compatibility:**
- All existing code continues to work
- Role parameter is optional
- Explicit fallback still takes precedence

**Testing:**
- Comprehensive tests in `tests/bugFixes.test.ts`
- Tests for each role's default dashboard
- Tests for redirect sanitization with role awareness
- All existing tests still pass (`tests/topBar.test.tsx`)

---

## Issue 4: Improved Error Handling

**General Improvements:**
- Better error messages for debugging
- Non-critical failures don't cause 500 errors
- Consistent error response shapes
- Added warning logs for non-critical failures

**API Routes Reviewed:**
- `/api/sales/dashboard` - Fixed leaderboard handling
- `/api/auth/login` - Added role to response
- `/api/auth/verify-2fa` - Added role to response
- All routes follow consistent error patterns

---

## Files Modified

### Created:
1. `app/(app)/team/page.tsx` - New team list page
2. `tests/bugFixes.test.ts` - Comprehensive bug fix tests
3. `tests/teamPage.test.tsx` - Team page tests
4. `BUG_FIXES_2026_01_31.md` - This documentation

### Modified:
1. `lib/types.ts` - Added role-aware redirect functions
2. `app/api/sales/dashboard/route.ts` - Fixed leaderboard error handling
3. `app/api/auth/login/route.ts` - Added role to response
4. `app/api/auth/verify-2fa/route.ts` - Added role to response
5. `components/auth/LoginForm.tsx` - Role-aware redirects
6. `components/auth/VerifyTwoFactorForm.tsx` - Role-aware redirects

---

## Test Results

All tests passing:

### Bug Fixes Tests (`tests/bugFixes.test.ts`)
- 22 tests passed
- Tests for getDefaultDashboard()
- Tests for sanitizeRedirect() with role awareness
- Tests for navigation home button
- Tests for backward compatibility

### Team Page Tests (`tests/teamPage.test.tsx`)
- 4 tests passed
- Route existence verification
- Permission checks
- Navigation item validation

### Existing Tests (`tests/topBar.test.tsx`)
- 17 tests passed
- All existing functionality preserved
- Backward compatibility confirmed

### Lint Status
- No errors (1 warning in unrelated file)
- All code follows ESLint rules
- React best practices enforced

---

## User Impact

### Sales Representatives
- Now correctly redirect to `/sales/dashboard` on login
- Home button takes them to their sales dashboard
- Better user experience with role-appropriate views

### Technicians
- Now correctly redirect to `/technician` on login
- Home button takes them to their daily view
- Consistent navigation experience

### Admin/Manager
- Can now access `/team` page to view team members
- See all team members at a glance
- Navigate to team member details
- Home button works as expected

### All Users
- More robust API error handling
- Better error messages
- Fewer 500 errors
- Improved reliability

---

## Deployment Notes

### No Database Changes
- All fixes are code-only
- No migrations required
- No schema changes

### No Breaking Changes
- Backward compatible API changes
- Existing code continues to work
- Optional parameters added, not required

### Environment Variables
- No new environment variables
- No changes to existing variables

### Testing Before Deploy
1. Run full test suite: `npm test`
2. Run typecheck: `npm run typecheck`
3. Run linter: `npm run lint`
4. Build check: `npm run build`

All should pass before deployment.

---

## Future Improvements

### Suggested Enhancements
1. Add team member search/filter on `/team` page
2. Add team member role filter dropdown
3. Cache role in localStorage to reduce API calls
4. Add team member quick actions (edit, deactivate)
5. Add team performance metrics on team page

### Related Backlog Items
- Full RLS audit for user_profiles table
- Team member invitation flow
- Role permission matrix UI
- Bulk user management

---

## Regression Prevention

All bugs fixed have corresponding tests to prevent regression:

1. **Sales dashboard API** - Tests verify empty leaderboard handling
2. **Team page** - Tests verify route exists and has correct permissions
3. **Navigation redirects** - Tests verify each role gets correct dashboard
4. **Redirect sanitization** - Tests verify security and role awareness

Run `npm test` before any deployment to ensure no regressions.

---

## Contact

For questions or issues related to these fixes, refer to:
- Code: Check the specific file paths above
- Tests: See `tests/bugFixes.test.ts` and `tests/teamPage.test.tsx`
- Documentation: This file and docs/ai/claude/CLAUDE.md
